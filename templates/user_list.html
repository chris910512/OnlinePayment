{% extends './base.html' %}

{% block content %}
    <style>
        input[disabled] {
            background-color: #ccc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th:nth-child(1), td:nth-child(1),
        th:nth-child(2), td:nth-child(2),
        th:nth-child(3), td:nth-child(3) {
            width: 15%;
        }
        th, td, tr {
            border: 1px solid #ddd;
            padding: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background-color: #003b49;
            color: white;
        }
        .dashboard {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .dashboard h2 {
            margin: 0 0 10px;
        }
        .pay-button {
            display: none;
        }
        .table-container {
            position: relative;
        }
        .toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
    </style>

    {% if request.user.is_authenticated %}
        <div class="dashboard">
            <h2>Welcome, {{ current_user_profile.first_name }} {{ current_user_profile.last_name }}</h2>
            <p>Your Currency: {{ current_user_profile.currency }}</p>
            <p>Your Balance: {{ current_user_profile.balance }}</p>
        </div>
        <div class="table-container">
            <table>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Currency</th>
                    <th>Action</th>
                </tr>
                {% for user in users %}
                    {% if user.user__username != request.user.username %}
                        <tr>
                            <td>{{ user.first_name }}</td>
                            <td>{{ user.last_name }}</td>
                            <td>{{ user.currency }}</td>
                            <td>
                                <form action="{% url 'make_payment' %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="recipient" value="{{ user.user__username }}">
                                    <input type="text" name="amount" placeholder="Amount" class="amount-input">
                                    <input type="submit" value="Pay" class="pay-button">
                                </form>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    {% else %}
        <p style="font-size: 2em; color: red; font-weight: bold;">Please login first.</p>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                <div class="toast-header">
                    <strong class="me-auto">{{ message.tags }}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    {{ message }}
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <script>
        window.onload = function() {
            var inputs = document.querySelectorAll("input[name='amount']");
            var buttons = document.querySelectorAll(".pay-button");

            for (var i = 0; i < buttons.length; i++) {
                buttons[i].style.display = "none";
            }

            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('input', function() {
                    if (this.value !== "") {
                        for (var j = 0; j < inputs.length; j++) {
                            if (inputs[j] !== this) {
                                buttons[j].style.display = "none";
                            } else {
                                buttons[j].style.display = "inline";
                            }
                        }
                    } else {
                        for (var j = 0; j < inputs.length; j++) {
                            buttons[j].style.display = "none";
                        }
                    }
                });
            }

            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('input', function() {
                    if (this.value !== "") {
                        for (var j = 0; j < inputs.length; j++) {
                            if (inputs[j] !== this) {
                                inputs[j].disabled = true;
                            }
                        }
                    } else {
                        for (var j = 0; j < inputs.length; j++) {
                            inputs[j].disabled = false;
                        }
                    }
                });
            }
        }
    </script>
{% endblock %}
